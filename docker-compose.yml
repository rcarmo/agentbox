x-agent: &agent
  image: ghcr.io/rcarmo/agentbox:latest
  environment:
    - DISPLAY=:1
    - TERM=xterm-256color
    - PUID=${PUID:-1000}
    - PGID=${PGID:-1000}
  restart: unless-stopped
  deploy:
    resources:
      limits:
        cpus: '${CPU_LIMITS:-2}'
        memory: '${MEMORY_LIMITS:-4G}'
  #privileged: true  # Required for Docker-in-Docker
  networks:
    - the_matrix

services:
  syncthing:
    image: syncthing/syncthing:latest
    container_name: agentbox-syncthing
    hostname: sandbox
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=Europe/Lisbon
      - HOME=/var/syncthing/config
      - STGUIADDRESS=0.0.0.0:8384
      - GOMAXPROCS=1
    volumes:
      - ./workspaces:/workspaces:Z
      - ./config:/var/syncthing/config:Z
    network_mode: host
    restart: unless-stopped
    cpuset: "0"
    cpu_shares: 2
    healthcheck:
      test: curl -fkLsS -m 2 127.0.0.1:8384/rest/noauth/health | grep -o --color=never OK || exit 1
      interval: 1m
      timeout: 10s
      retries: 3

  gotel:
    <<: *agent
    container_name: agent-gotel
    hostname: gotel
    ports:
      - "2222:22"    # SSH
      - "3390:3389"  # RDP (xrdp)
      - "3000:3000"  # web service
    volumes:
      - home:/home/agent
      - ./workspaces/gotel:/workspace

  guerite:
    <<: *agent
    container_name: agent-guerite
    hostname: guerite
    ports:
      - "2223:22"    # SSH
      - "3391:3389"  # RDP (xrdp)
      - "3001:3000"  # web service
    volumes:
      - home:/home/agent
      - ./workspaces/guerite:/workspace

  feed-summarizer:
    <<: *agent
    container_name: agent-feed-summarizer
    hostname: feed-summarizer
    ports:
      - "2224:22"    # SSH
      - "3392:3389"  # RDP (xrdp)
      - "3003:3000"  # web service
    volumes:
      - home:/home/agent
      - ./workspaces/feed-summarizer:/workspace

volumes:
  home:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./home

networks:
  the_matrix:
    driver: bridge