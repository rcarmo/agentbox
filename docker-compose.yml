---
x-env: &env
  DISPLAY: ":10"
  TERM: xterm-256color
  PUID: "${PUID:-1000}"
  PGID: "${PGID:-1000}"
  TZ: Europe/Lisbon

x-agent: &agent
  image: ghcr.io/rcarmo/agentbox:latest
  environment:
    <<: *env
  restart: unless-stopped
  deploy:
    resources:
      limits:
        cpus: '${CPU_LIMITS:-2}'
        memory: '${MEMORY_LIMITS:-4G}'
  privileged: true  # Required for Docker-in-Docker
  networks:
    - the_matrix

services:
  syncthing:
    image: syncthing/syncthing:latest
    container_name: agent-syncthing
    hostname: sandbox
    environment:
      <<: *env
      HOME: /var/syncthing/config
      STGUIADDRESS: 0.0.0.0:8384
      GOMAXPROCS: "2"
    volumes:
      - ./workspaces:/workspaces:Z
      - ./config:/var/syncthing/config:Z
    network_mode: host
    restart: unless-stopped
    cpuset: "0"
    cpu_shares: 2
    healthcheck:
      test: curl -fkLsS -m 2 127.0.0.1:8384/rest/noauth/health | grep -o --color=never OK || exit 1
      interval: 1m
      timeout: 10s
      retries: 3

  gotel:
    <<: *agent
    container_name: agent-gotel
    hostname: gotel
    environment:
      <<: *env
      ENABLE_DOCKER: "true"
    ports:
      - "3000:3000"  # web service
      - "3020:3020"  # web service
    volumes:
      - local:/home/agent/.local:Z
      - gitconfig:/home/agent/.gitconfig:ro
      - copilot:/home/agent/.copilot:Z
      - vibe:/home/agent/.vibe:Z
      - ./workspaces/gotel:/workspace:Z

  guerite:
    <<: *agent
    container_name: agent-guerite
    hostname: guerite
    environment:
      <<: *env
      ENABLE_DOCKER: "true"
    volumes:
      - local:/home/agent/.local:Z
      - gitconfig:/home/agent/.gitconfig:ro
      - copilot:/home/agent/.copilot:Z
      - vibe:/home/agent/.vibe:Z
      - ./workspaces/guerite:/workspace:Z

  feed-summarizer:
    <<: *agent
    container_name: agent-feed-summarizer
    hostname: feed-summarizer
    volumes:
      - local:/home/agent/.local:Z
      - gitconfig:/home/agent/.gitconfig:ro
      - copilot:/home/agent/.copilot:Z
      - vibe:/home/agent/.vibe:Z
      - ./workspaces/feed-summarizer:/workspace:Z

  go-html5:
    <<: *agent
    container_name: agent-go-html5
    hostname: go-html5
    ports:
      - "3000:3000"  # web service
    volumes:
      - local:/home/agent/.local:Z
      - gitconfig:/home/agent/.gitconfig:ro
      - copilot:/home/agent/.copilot:Z
      - vibe:/home/agent/.vibe:Z
      - ./workspaces/go-html5:/workspace:Z

  toad:
    <<: *agent
    container_name: agent-toad
    hostname: toad
    ports:
      - "8001:8000"  # web service
    volumes:
      - local:/home/agent/.local:Z
      - gitconfig:/home/agent/.gitconfig:ro
      - copilot:/home/agent/.copilot:Z
      - vibe:/home/agent/.vibe:Z
      - ./workspaces/toad:/workspace:Z

  agentbox:
    <<: *agent
    container_name: agent-agentbox
    hostname: agent
    ports:
      - "8002:8000"  # web service
    volumes:
      - local:/home/agent/.local:Z
      - gitconfig:/home/agent/.gitconfig:ro
      - copilot:/home/agent/.copilot:Z
      - vibe:/home/agent/.vibe:Z
      - ./workspaces/agentbox:/workspace:Z

volumes:
  gitconfig:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./home/.gitconfig
  copilot:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./home/.copilot
  vibe:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./home/.vibe
  local:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./home/.local

networks:
  the_matrix:
    driver: bridge
