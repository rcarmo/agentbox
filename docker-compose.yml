---
x-env: &env
  DISPLAY: ":10"
  TERM: xterm-256color
  PUID: "${PUID:-1000}"
  PGID: "${PGID:-1000}"
  TZ: Europe/Lisbon

x-agent: &agent
  image: ghcr.io/rcarmo/agentbox:latest
  environment:
    <<: *env
  restart: unless-stopped
  deploy:
    resources:
      limits:
        cpus: '${CPU_LIMITS:-2}'
        memory: '${MEMORY_LIMITS:-4G}'
  privileged: true  # Required for Docker-in-Docker
  networks:
    - the_matrix

services:
  syncthing:
    image: syncthing/syncthing:latest
    container_name: agent-syncthing
    hostname: sandbox
    environment:
      <<: *env
      HOME: /var/syncthing/config
      STGUIADDRESS: 0.0.0.0:8384
      GOMAXPROCS: "2"
    volumes:
      - ./workspaces:/workspaces
      - ./config:/var/syncthing/config
    network_mode: host
    restart: unless-stopped
    cpuset: "0"
    cpu_shares: 2
    healthcheck:
      test: curl -fkLsS -m 2 127.0.0.1:8384/rest/noauth/health | grep -o --color=never OK || exit 1
      interval: 1m
      timeout: 10s
      retries: 3

  toad:
    <<: *agent
    container_name: agent-toad
    hostname: toad
    ports:
      - "8001:8000"  # web service
    volumes:
      - ./home/.gitconfig:/home/agent/.gitconfig:ro
      - local:/home/agent/.local
      - copilot:/home/agent/.copilot
      - vibe:/home/agent/.vibe
      - ./workspaces/toad:/workspace

  copilot:
    <<: *agent
    container_name: agent-copilot
    hostname: copilot
    ports:
      - "8002:8000"  # web service
    volumes:
      - ./home/.gitconfig:/home/agent/.gitconfig:ro
      - local:/home/agent/.local
      - copilot:/home/agent/.copilot
      - vibe:/home/agent/.vibe
      - ./workspaces/agentbox:/workspace

volumes:
  copilot:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./home/.copilot
  vibe:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./home/.vibe
  local:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./home/.local

networks:
  the_matrix:
    driver: bridge
